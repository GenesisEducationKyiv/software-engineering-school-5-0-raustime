name: Run All Tests

on:
  push:
    branches: [main]
  pull_request:

env:
  COMPOSE_PROJECT_NAME: weatherapi
  DOCKER_BUILDKIT: 1

jobs:
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:24.0.5-dind
        options: --privileged
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Compose
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: cp .env.ci .env

      - name: Start Postgres
        run: docker compose up -d db

      - name: Run Unit Tests
        run: docker compose run --rm test-runner-unit

      - name: Clean up
        run: docker compose down -v

  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:24.0.5-dind
        options: --privileged
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Compose
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: cp .env.ci .env

      - name: Start Postgres
        run: docker compose up -d db

      - name: Wait for DB
        run: sleep 5

      - name: Create test database
        env:
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
        run: |
          docker exec $(docker compose ps -q db) psql -U "$POSTGRES_USER" -c "CREATE DATABASE weatherdb_test;"

      - name: Run Integration Tests
        run: docker compose run --rm test-runner-integration

      - name: Clean up
        run: docker compose down -v

  e2e-tests:
    name: ðŸ§ª E2E Tests
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:24.0.5-dind
        options: --privileged
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Compose
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: cp .env.ci .env

      - name: Start services (API, DB, E2E)
        run: docker compose up -d db api test-runner-e2e

      - name: Wait for services
        run: sleep 10

      - name: Run E2E tests
        run: docker compose exec -T test-runner-e2e make test-e2e

      - name: Clean up
        run: docker compose down -v
