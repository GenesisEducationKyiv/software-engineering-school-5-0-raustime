# ---- build stage ----
FROM golang:1.23 AS builder

WORKDIR /app
COPY go.mod ./
COPY go.sum ./
RUN go mod download

COPY . .
COPY migrations ./migrations

# üîß –ù–∞–∑–≤–∞ –±—ñ–Ω–∞—Ä–Ω–∏–∫–∞ ‚Äî subscription
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o subscription ./cmd/main.go

# ---- run stage ----
FROM gcr.io/distroless/static:nonroot

WORKDIR /app

# –ë—ñ–Ω–∞—Ä–Ω–∏–∫ —ñ, –∑–∞ –ø–æ—Ç—Ä–µ–±–∏, –º—ñ–≥—Ä–∞—Ü—ñ—ó –∞–±–æ —à–∞–±–ª–æ–Ω–∏
COPY --from=builder /app/subscription /app/subscription
COPY --from=builder /app/migrations /app/migrations

ENV GRPC_PORT=8090
ENV HTTP_PORT=8091

EXPOSE 8090
EXPOSE 8091

ENTRYPOINT ["/app/subscription"]